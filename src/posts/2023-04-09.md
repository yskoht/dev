# misc: 近況

この 7 週間くらいはログインのリファクタリングをしていた。 2023-02-13 から始めて、
[2023-03-15](https://yskoht.github.io/dev/2023-03-15)でローカルで動くようになり、
2023-04-02 でデプロイまでできるようになった。

---

# pmdr: cookie

- Google カレンダー API でイベントを連携できるようにしたい
- そのために OAuth で認証する
- 認証に成功するとトークンがブラウザに渡されて、ブラウザは callback を GET する
  - その時にトークンをパラメータとして渡してくれる
- 現状のセッションは Authorization ヘッダーを js で設定している
  - なので callback 呼び出し時のセッションが不明
- セッションが cookie だとブラウザがつけてくれるので便利
  - SSR もできる
- ブラウザは cookie をつけて web サーバにアクセスする
  - web サーバは cookie を検証する
  - ログイン状態であれば、web サーバーからバックエンドにアクセスして返す
  - 非ログイン状態であれば、ログイン画面にリダイレクトする
    - クライアント側ではログイン/非ログイン状態管理しない
- ブラウザから js でバックエンドにアクセスしたいことがある
  - バックエンドにも cookie の検証処理を入れる？
    - web サーバーからバックエンドにアクセスする時にもセッションが必要になる
    - バックエンドには cookie 検証済みの状態でアクセスするようにしたい
  - バックエンドの前にゲートウェイサーバを建てる
    - ブラウザはゲートウェイサーバにアクセスする
    - ゲートウェイは cookie の検証をし、バックエンドに渡す
  - バックエンドは web サーバ、またはゲートウェイからだけ呼び出せるようにする

---

# pmdr: Cloud Run（内部からのみ）

- バックエンドの Cloud Run を内部からのみアクセス可能にしたい
- 2 つ方法がある(?)
  - 内向きの設定を内部にする
  - Cloud IAM で認証を必要にする
- 内向きの設定を内部にする
  - VPC を設定して、サーバーレス VPC アクセスコネクタを使うとできる気がする
    - [Google Cloud の VPC を基礎から始める](https://zenn.dev/google_cloud_jp/articles/google-cloud-vpc-101)
  - 色々試してみたが、よく分かってない
- Cloud IAM で認証を必要にする
  - web サーバ、ゲートウェイサーバ、バックエンドサーバにそれぞれサービスアカウントを作成し、Cloud Run に設定する
  - バックエンドに `認証が必要です` を設定する
  - バックエンドの `Cloud Run起動元` に呼び出しを許可するサービスアカウントを設定する
  - トラフィックが外部に出てしまうがサービスアカウントだけ設定すればローカルからでも呼び出せる
