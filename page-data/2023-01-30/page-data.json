{"componentChunkName":"component---src-templates-post-tsx","path":"/2023-01-30","result":{"data":{"markdownRemark":{"html":"<h1>pmdr: Artifact Registry</h1>\n<p>イメージの一覧</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">gcloud artifacts <span class=\"token function\">docker</span> images list <span class=\"token variable\">${REGION}</span>.pkg.dev/<span class=\"token variable\">${PROJECT_ID}</span>/<span class=\"token variable\">${REPOSITORY_ID}</span></code></pre></div>\n<p>2 週間以内でフィルタ。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">gcloud artifacts <span class=\"token function\">docker</span> images list <span class=\"token variable\">${REGION}</span>.pkg.dev/<span class=\"token variable\">${PROJECT_ID}</span>/<span class=\"token variable\">${REPOSITORY_ID}</span> <span class=\"token parameter variable\">--filter</span><span class=\"token operator\">=</span><span class=\"token string\">\"createTime>-P2W\"</span></code></pre></div>\n<p><code class=\"language-text\">CREATE_TIME</code> でソート。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">gcloud artifacts <span class=\"token function\">docker</span> images list <span class=\"token variable\">${REGION}</span>.pkg.dev/<span class=\"token variable\">${PROJECT_ID}</span>/<span class=\"token variable\">${REPOSITORY_ID}</span> --sort-by<span class=\"token operator\">=</span><span class=\"token string\">\"CREATE_TIME\"</span></code></pre></div>\n<p>降順。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">gcloud artifacts <span class=\"token function\">docker</span> images list <span class=\"token variable\">${REGION}</span>.pkg.dev/<span class=\"token variable\">${PROJECT_ID}</span>/<span class=\"token variable\">${REPOSITORY_ID}</span> --sort-by<span class=\"token operator\">=</span><span class=\"token string\">\"~CREATE_TIME\"</span></code></pre></div>\n<p>10 件で limit。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">gcloud artifacts <span class=\"token function\">docker</span> images list <span class=\"token variable\">${REGION}</span>.pkg.dev/<span class=\"token variable\">${PROJECT_ID}</span>/<span class=\"token variable\">${REPOSITORY_ID}</span> <span class=\"token parameter variable\">--limit</span><span class=\"token operator\">=</span><span class=\"token number\">10</span></code></pre></div>\n<p>format。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">gcloud artifacts <span class=\"token function\">docker</span> images list <span class=\"token variable\">${REGION}</span>.pkg.dev/<span class=\"token variable\">${PROJECT_ID}</span>/<span class=\"token variable\">${REPOSITORY_ID}</span> <span class=\"token parameter variable\">--format</span><span class=\"token operator\">=</span><span class=\"token string\">\"value(DIGEST)\"</span></code></pre></div>\n<p>いまやりたいことは、最新 n 件のイメージを残してそれ以外を削除すること。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">gcloud artifacts <span class=\"token function\">docker</span> images list <span class=\"token variable\">${REGION}</span>.pkg.dev/<span class=\"token variable\">${PROJECT_ID}</span>/<span class=\"token variable\">${REPOSITORY_ID}</span> <span class=\"token parameter variable\">--format</span><span class=\"token operator\">=</span><span class=\"token string\">\"value(DIGEST)\"</span> <span class=\"token operator\">></span> allItems.txt\ngcloud artifacts <span class=\"token function\">docker</span> images list <span class=\"token variable\">${REGION}</span>.pkg.dev/<span class=\"token variable\">${PROJECT_ID}</span>/<span class=\"token variable\">${REPOSITORY_ID}</span> --sort-by<span class=\"token operator\">=</span><span class=\"token string\">\"~CREATE_TIME\"</span> <span class=\"token parameter variable\">--limit</span><span class=\"token operator\">=</span><span class=\"token number\">10</span> <span class=\"token parameter variable\">--format</span><span class=\"token operator\">=</span><span class=\"token string\">\"value(DIGEST)\"</span> <span class=\"token operator\">></span> toKeep.txt\n<span class=\"token function\">sort</span> allItems.txt toKeep.txt <span class=\"token operator\">|</span> <span class=\"token function\">uniq</span> <span class=\"token parameter variable\">-u</span> <span class=\"token operator\">></span> toDelete.txt\n<span class=\"token function\">cat</span> toDelete.txt <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> <span class=\"token parameter variable\">-n1</span> -I<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> gcloud artifacts <span class=\"token function\">docker</span> images delete <span class=\"token parameter variable\">--quiet</span> <span class=\"token parameter variable\">--async</span> <span class=\"token variable\">${REGION}</span>.pkg.dev/<span class=\"token variable\">${PROJECT_ID}</span>/<span class=\"token variable\">${REPOSITORY_ID}</span>/<span class=\"token variable\">${IMAGE_PATH}</span>@<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Cloud Build でイメージを作成した後に実行するようにした。</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"gcr.io/cloud-builders/gcloud\"</span>\n  <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"bash\"</span>\n  <span class=\"token key atrule\">args</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"delete-old-images-from-artifact-registry.sh\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<ul>\n<li><a href=\"https://cloud.google.com/sdk/gcloud/reference/topic/filters\">gcloud topic filters  |  Google Cloud CLI Documentation</a></li>\n<li><a href=\"https://cloud.google.com/compute/docs/gcloud-compute/tips?hl=ja\">gcloud compute 使用上のヒント  |  Compute Engine ドキュメント  |  Google Cloud</a></li>\n<li><a href=\"https://medium.com/veltra-engineering/uniq-command-and-set-operations-bd4f04b17d9a\">uniq コマンドと集合演算. uniq command and set operations. | by Goro Yanagi | VELTRA Engineering | Medium</a></li>\n<li><a href=\"https://alpacat.com/blog/delete-old-docker-images-in-artifact-registry\">Artifact Registry にある古い Docker イメージを Cloud Build から削除する - アルパカログ</a></li>\n</ul>\n<hr>\n<h1>pmdr: タスクの更新</h1>\n<p>更新できるようになった。</p>\n<hr>\n<h1>pmdr: turborepo-remote-cache</h1>\n<p>やってみるだけやってみたが、Next アプリがキャッシュされない。そもそもローカルにもキャッシュされない。後でもう一回やるかも。</p>\n<ul>\n<li><a href=\"https://zenn.dev/aiji42/articles/7bc1b6df91dd76\">Turborepo のリモートキャッシュサーバを Cloud Run と GCS で構築する</a></li>\n<li><a href=\"https://zenn.dev/silverbirder/articles/af8bf125bd33ad\">turborepo-remote-cache でキャッシュサーバをセルフホストした</a></li>\n<li><a href=\"https://github.com/ducktors/turborepo-remote-cache\">ducktors/turborepo-remote-cache: Open source implementation of the Turborepo custom remote cache server.</a></li>\n</ul>","fields":{"slug":"/2023-01-30"}}},"pageContext":{"slug":"/2023-01-30","prevSlug":"/2023-01-29","nextSlug":"/2023-02-05"}},"staticQueryHashes":["63159454"]}