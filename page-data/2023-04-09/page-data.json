{"componentChunkName":"component---src-templates-post-tsx","path":"/2023-04-09","result":{"data":{"markdownRemark":{"html":"<h1>misc: 近況</h1>\n<p>この 7 週間くらいはログインのリファクタリングをしていた。 2023-02-13 から始めて、\n<a href=\"https://yskoht.github.io/dev/2023-03-15\">2023-03-15</a>でローカルで動くようになり、\n2023-04-02 でデプロイまでできるようになった。</p>\n<hr>\n<h1>pmdr: cookie</h1>\n<ul>\n<li>Google カレンダー API でイベントを連携できるようにしたい</li>\n<li>そのために OAuth で認証する</li>\n<li>認証に成功するとトークンがブラウザに渡されて、ブラウザは callback を GET する\n<ul>\n<li>その時にトークンをパラメータとして渡してくれる</li>\n</ul>\n</li>\n<li>現状のセッションは Authorization ヘッダーを js で設定している\n<ul>\n<li>なので callback 呼び出し時のセッションが不明</li>\n</ul>\n</li>\n<li>セッションが cookie だとブラウザがつけてくれるので便利\n<ul>\n<li>SSR もできる</li>\n</ul>\n</li>\n<li>ブラウザは cookie をつけて web サーバにアクセスする\n<ul>\n<li>web サーバは cookie を検証する</li>\n<li>ログイン状態であれば、web サーバーからバックエンドにアクセスして返す</li>\n<li>非ログイン状態であれば、ログイン画面にリダイレクトする\n<ul>\n<li>クライアント側ではログイン/非ログイン状態管理しない</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>ブラウザから js でバックエンドにアクセスしたいことがある\n<ul>\n<li>バックエンドにも cookie の検証処理を入れる？\n<ul>\n<li>web サーバーからバックエンドにアクセスする時にもセッションが必要になる</li>\n<li>バックエンドには cookie 検証済みの状態でアクセスするようにしたい</li>\n</ul>\n</li>\n<li>バックエンドの前にゲートウェイサーバを建てる\n<ul>\n<li>ブラウザはゲートウェイサーバにアクセスする</li>\n<li>ゲートウェイは cookie の検証をし、バックエンドに渡す</li>\n</ul>\n</li>\n<li>バックエンドは web サーバ、またはゲートウェイからだけ呼び出せるようにする</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h1>pmdr: Cloud Run（内部からのみ）</h1>\n<ul>\n<li>バックエンドの Cloud Run を内部からのみアクセス可能にしたい</li>\n<li>2 つ方法がある(?)\n<ul>\n<li>内向きの設定を内部にする</li>\n<li>Cloud IAM で認証を必要にする</li>\n</ul>\n</li>\n<li>内向きの設定を内部にする\n<ul>\n<li>VPC を設定して、サーバーレス VPC アクセスコネクタを使うとできる気がする\n<ul>\n<li><a href=\"https://zenn.dev/google_cloud_jp/articles/google-cloud-vpc-101\">Google Cloud の VPC を基礎から始める</a></li>\n</ul>\n</li>\n<li>色々試してみたが、よく分かってない</li>\n</ul>\n</li>\n<li>Cloud IAM で認証を必要にする\n<ul>\n<li>web サーバ、ゲートウェイサーバ、バックエンドサーバにそれぞれサービスアカウントを作成し、Cloud Run に設定する</li>\n<li>バックエンドに <code class=\"language-text\">認証が必要です</code> を設定する</li>\n<li>バックエンドの <code class=\"language-text\">Cloud Run起動元</code> に呼び出しを許可するサービスアカウントを設定する</li>\n<li>トラフィックが外部に出てしまうがサービスアカウントだけ設定すればローカルからでも呼び出せる</li>\n</ul>\n</li>\n</ul>","fields":{"slug":"/2023-04-09"}}},"pageContext":{"slug":"/2023-04-09","prevSlug":"/2023-04-02","nextSlug":"/2023-04-10"}},"staticQueryHashes":["63159454"]}