{"componentChunkName":"component---src-templates-post-tsx","path":"/2023-05-11","result":{"data":{"markdownRemark":{"html":"<h1>cgc: patch-package</h1>\n<ul>\n<li><a href=\"https://github.com/ds300/patch-package\">ds300/patch-package: Fix broken node modules instantly 🏃🏽‍♀️💨</a></li>\n</ul>\n<p>asdf を使って git をインストールしているとパッチの作成が失敗する。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ npx patch-package ink\npatch-package <span class=\"token number\">7.0</span>.0\n• Creating temporary folder\n• Installing ink@4.2.0 with <span class=\"token function\">npm</span>\n• Diffing your files with clean files\nunknown command: git. Perhaps you have to reshim?</code></pre></div>\n<ul>\n<li><a href=\"https://github.com/ds300/patch-package/blob/0b9b0150a2348bf53087198fcad84e862a35eebb/src/makePatch.ts#L169-L174\">makePackch.ts#L169-L174</a></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">git</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  <span class=\"token function\">spawnSafeSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"git\"</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    cwd<span class=\"token operator\">:</span> tmpRepo<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\n    env<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">,</span> <span class=\"token constant\">HOME</span><span class=\"token operator\">:</span> tmpRepo<span class=\"token punctuation\">.</span>name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    maxBuffer<span class=\"token operator\">:</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">HOME</code> が置き換えられているので、 <code class=\"language-text\">.asdf</code> が見つからない。\n<code class=\"language-text\">patch-package</code> に以下をパッチすると動く。</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">diff --git a/node_modules/patch-package/dist/makePatch.js b/node_modules/patch-package/dist/makePatch.js\nindex a76e39c..5cbd541 100644\n<span class=\"token coord\">--- a/node_modules/patch-package/dist/makePatch.js</span>\n<span class=\"token coord\">+++ b/node_modules/patch-package/dist/makePatch.js</span>\n@@ -102,6 +102,14 @@ function makePatch({ packagePathSpecifier, appPath, packageManager, includePaths\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>                });\n<span class=\"token prefix unchanged\"> </span>            }\n<span class=\"token prefix unchanged\"> </span>        }\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>\n<span class=\"token prefix inserted\">+</span>        // for asdf\n<span class=\"token prefix inserted\">+</span>        try {\n<span class=\"token prefix inserted\">+</span>            const os = require(\"os\");\n<span class=\"token prefix inserted\">+</span>            spawnSafe_1.spawnSafeSync(\"ln\", [\"-s\", `${os.homedir}/.asdf`, '.'], { cwd: tmpRepo.name });\n<span class=\"token prefix inserted\">+</span>            spawnSafe_1.spawnSafeSync(\"ln\", [\"-s\", `${os.homedir}/.tool-versions`, '.'], { cwd: tmpRepo.name });\n<span class=\"token prefix inserted\">+</span>        } catch {}\n<span class=\"token prefix inserted\">+</span>\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>        const git = (...args) => spawnSafe_1.spawnSafeSync(\"git\", args, {\n<span class=\"token prefix unchanged\"> </span>            cwd: tmpRepo.name,\n<span class=\"token prefix unchanged\"> </span>            env: Object.assign(Object.assign({}, process.env), { HOME: tmpRepo.name }),</span></code></pre></div>","fields":{"slug":"/2023-05-11"}}},"pageContext":{"slug":"/2023-05-11","prevSlug":"/2023-04-29","nextSlug":"/2023-05-20"}},"staticQueryHashes":["63159454"]}